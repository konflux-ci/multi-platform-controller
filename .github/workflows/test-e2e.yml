name: E2E Tests

on:
  pull_request_target:
    types: [opened, synchronize, reopened, labeled, unlabeled]

  merge_group:
    types: [checks_requested]

  push:
    branches: [ main ]

permissions:
  id-token: write

jobs:
  check-prerequisites:
    runs-on: ubuntu-slim
    steps:
    - name: Check prerequisites for running Sanity test
      run: |
        if [ "${{ github.event_name }}" != 'pull_request_target' ]; then
          echo "The workflow is not triggered from PR, but ${{ github.event_name }} - skipping further checks."
          exit 0
        fi

        WHITELISTED_BOT_NAME="renovate[bot]"
        REQUIRED_LABEL_NAME="ok-to-test"

        ORG="${{ github.repository_owner }}"
        PR_AUTHOR=$(jq --raw-output .pull_request.user.login $GITHUB_EVENT_PATH)
        PR_LABELS=$(jq --raw-output .pull_request.labels[].name $GITHUB_EVENT_PATH)

        if [ "$PR_AUTHOR" == "$WHITELISTED_BOT_NAME" ]; then
          echo "PR author is "$WHITELISTED_BOT_NAME", skipping further checks."
          exit 0
        fi

        if [[ "$PR_LABELS" == *$REQUIRED_LABEL_NAME* ]]; then
          echo "PR has '$REQUIRED_LABEL_NAME' label, skipping further checks."
          exit 0
        fi

        if gh api "/orgs/$ORG/members/$PR_AUTHOR"; then
          echo "PR author is a member of $ORG GitHub organization, skipping further checks"
          exit 0
        fi

        ERROR_SUMMARY=$(cat <<EOF

        ### âŒ Cannot run Sanity test - at least one of the following conditions must be met:
        * PR author is '$WHITELISTED_BOT_NAME'
        * PR has label '$REQUIRED_LABEL_NAME'
        * PR author is a public member of '$ORG' GitHub organization
        EOF
        )
        echo "$ERROR_SUMMARY" >> $GITHUB_STEP_SUMMARY
        echo "$ERROR_SUMMARY"

        exit 1
      env:
        GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}

  test-e2e:
    needs: check-prerequisites
    name: Run on Ubuntu
    runs-on: ubuntu-latest
    env:
      AWS_ROLE_ARN: arn:aws:iam::418272753558:role/multi-platform-github-action
      AWS_REGION: us-east-1
      AWS_ROLE_DURATION: 900 # 15 minutes
      INSTANCE_TAG: ${{ github.run_id }}-development
      KIND_EXPERIMENTAL_PROVIDER: podman
      E2E_DEBUG_LOG_DIR: ${{ github.workspace }}/e2e-debug-logs
    steps:
      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          # this might remove tools that are actually needed,
          # if set to "true" but frees about 6 GB
          tool-cache: false

          docker-images: false

      - name: Clone the code
        uses: actions/checkout@v6
        with:
          ref: "${{ github.event.pull_request.head.sha }}"

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: ${{ env.AWS_ROLE_DURATION }}

      - name: Validate AWS Credentials
        run: |
          aws sts get-caller-identity

      - name: Setup Go
        uses: actions/setup-go@v6
        with:
          go-version-file: go.mod

      - name: Install the latest version of kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/latest/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Verify kind installation
        run: kind version

      - name: Create kind cluster
        run: kind create cluster

      - name: Build and load images
        run: |
          go mod tidy
          make load-image
          podman exec kind-control-plane crictl images

      - name: Install dependencies
        run: |
          make tekton
          make cert-manager

      - name: Deploy MPC
        run: |
          make deploy

      - name: Run Test e2e
        run: |
          make test-e2e

      - name: Upload E2E Debug Logs
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: e2e-debug-logs
          path: ${{ env.E2E_DEBUG_LOG_DIR }}
          if-no-files-found: ignore
          retention-days: 14

      # Reconfigure AWS credentials for cleanup to ensure they're available even if
      # The credentials expired (15-minute duration) during long-running tests

      - name: Configure AWS Credentials for Cleanup
        if: always()
        uses: aws-actions/configure-aws-credentials@v5.1.1
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-duration-seconds: ${{ env.AWS_ROLE_DURATION }}

      - name: Delete AWS EC2 Instances
        if: always()
        run: ./out/devsetup cleanup-instances ${{ env.INSTANCE_TAG }}

      - name: Delete AWS EC2 Key Pair
        if: always()
        run: ./out/devsetup cleanup-keypair ${{ github.run_id }}
